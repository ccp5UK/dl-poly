From 5c5237e096df4a44b05696c9292b728b096189f8 Mon Sep 17 00:00:00 2001
From: Alin Marin Elena <alin@elena.space>
Date: Tue, 4 Aug 2015 17:48:47 +0100
Subject: [PATCH 1/4] [cmake] added support for PLUMED in the build system

---
 CMakeLists.txt                 | 14 +++++++++++---
 build/build-plumed.sh          | 34 ++++++++++++++++++++++++++++++++++
 cmake/DLPOLYBuildOptions.cmake |  1 +
 source/CMakeLists.txt          | 12 +++++++++---
 4 files changed, 55 insertions(+), 6 deletions(-)
 create mode 100755 build/build-plumed.sh

diff --git a/CMakeLists.txt b/CMakeLists.txt
index fe64db9..320e3e4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -7,10 +7,10 @@ set(DLPOLY_VERSION "${DLPOLY_VERSION_MAJOR}.${DLPOLY_VERSION_MINOR}.${DLPOLY_VER
 set(AUTHOR "Alin M Elena")
 set(AUTHOR_DETAILS "alin.m.elena@gmail.com")
 set(DESCRIPTION "DL_POLY")
+
 set(src_dir source) 
 set(target_name DLPOLY.Z) 
 
-
 set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake" "${CMAKE_SOURCE_DIR}/cmake/Modules")
 include(DLPOLYBuildOptions)
 include(DLPOLYBuildFunctions)
@@ -20,6 +20,7 @@ cmake_minimum_required(VERSION 3.0.2)
 if(COMMAND cmake_policy)
   cmake_policy(SET CMP0004 OLD)
 endif(COMMAND cmake_policy)
+
 if(WITH_MPI)
 ### if we want MPI check for it and set the internal kitchen
   find_package(MPI REQUIRED)
@@ -74,6 +75,13 @@ if(WITH_KIM)
 else()
    message(STATUS "Build without KIM support")
 endif()
+if(WITH_PLUMED)
+   find_package(PLUMED 2.1 REQUIRED)
+   message(STATUS "Build with PLUMED support")
+   set(LIBS ${LIBS} ${PLUMED_LIBRARIES})
+else()
+   message(STATUS "Build without PLUMED support")
+endif()
 
 if(WITH_EXTRATIME)
    add_definitions("-DCHRONO")
@@ -92,8 +100,8 @@ if (DOCS)
 endif()
 ######################
 ##set the output folder for libs and bins
-set(LIBRARY_OUTPUT_PATH ${CMAKE_INSTALL_LIBDIR})
-set(EXECUTABLE_OUTPUT_PATH ${CMAKE_INSTALL_BINDIR})
+set(LIBRARY_OUTPUT_PATH ${PROJECT_BINARY_DIR}/${CMAKE_INSTALL_LIBDIR})
+set(EXECUTABLE_OUTPUT_PATH ${PROJECT_BINARY_DIR}/${CMAKE_INSTALL_BINDIR})
 
 add_subdirectory(source)
 
diff --git a/build/build-plumed.sh b/build/build-plumed.sh
new file mode 100755
index 0000000..5b91fb7
--- /dev/null
+++ b/build/build-plumed.sh
@@ -0,0 +1,34 @@
+#!/usr/bin/env bash
+
+
+module load gnu-openmpi/1.8.3
+module list
+CC=gcc
+CXX=g++
+PLUMED_VERSION=2.2b
+PLUMED_SRC=plumed-${PLUMED_VERSION}.tgz
+BUILD_FOLDER=build-$CC
+PLUMED_INSTALL=/opt/plumed/$CC/$PLUMED_VERSION
+PLUMED_MODULE=/opt/modules/plumed/$CC/$PLUMED_VERSION
+CXXFLAGS="-O3 -mtune=native" 
+CFLAGS="-O3 -mtune=native"
+VMD_PLUGIN=/usr/lib64/vmd/1.9.2beta1.1427136773/plugins
+VMD_INC="-I$VMD_PLUGIN/include -I$VMD_PLUGIN/LINUXAMD64/molfile "
+LIBS="-lnetcdf -ltcl8.6 "
+rm -rf $BUILD_FOLDER
+mkdir -p $BUILD_FOLDER
+pushd $BUILD_FOLDER
+tar -xvf ../$PLUMED_SRC
+pushd plumed-${PLUMED_VERSION}
+patch -p1 < ../../0001-fix-template-issue-for-optimalAlignment.patch
+
+./configure LDFLAGS="-L$VMD_PLUGIN/LINUXAMD64/molfile" CPPFLAGS="$VMD_INC" LIBS="$LIBS"  CXXFLAGS="$CXXFLAGS" CFLAGS="$CFLAGS" \
+ --prefix=$PLUMED_INSTALL \
+  --enable-external-molfile-plugins --enable-external-lapack \
+ --enable-mpi --enable-openmp
+make -j10
+make install
+popd 
+popd 
+mkdir -p $(dirname $PLUMED_MODULE)
+cp $PLUMED_INSTALL/lib/plumed/src/lib/modulefile $PLUMED_MODULE
diff --git a/cmake/DLPOLYBuildOptions.cmake b/cmake/DLPOLYBuildOptions.cmake
index 487b3ee..05e90b6 100644
--- a/cmake/DLPOLYBuildOptions.cmake
+++ b/cmake/DLPOLYBuildOptions.cmake
@@ -4,5 +4,6 @@ option(WITH_PHI "build an executable for Xeon Phi version" OFF)
 option(WITH_NETCDF "build using netcdf support version" OFF)
 option(WITH_EXTRATIME "activate extra timing information" OFF)
 option(WITH_KIM "Build with KIM support" OFF)
+option(WITH_PLUMED "Build with PLUMED support" OFF)
 option(DOCS "Doxygen Documentation" OFF)
 option(BUILD_SHARED_LIBS "Build with shared libraries" OFF)
diff --git a/source/CMakeLists.txt b/source/CMakeLists.txt
index 99cdce6..5791fc7 100644
--- a/source/CMakeLists.txt
+++ b/source/CMakeLists.txt
@@ -210,11 +210,17 @@ if(WITH_KIM)
 else()
   set(kim_SRCS kim_modul~.f90)
 endif()
+if(WITH_PLUMED)
+  set(plumed_SRCS plumed_module.F90)
+else()
+  set(plumed_SRCS plumed_modul~.f90)
+endif()
 
 add_library(dlpoly  ${dlpoly_SRCS} ${dlpoly_SERIAL_SRCS} ${netcdf_SRCS})
 add_library(dlpolycore  ${dlpoly_CORE_SRCS})
 add_library(dlpolythermo  ${dlpoly_THERMO_SRCS})
 add_library(dlpolykim  ${kim_SRCS})
+add_library(dlpolyplumed  ${plumed_SRCS})
 
 ## sets the linking
 link_directories (${LIBRARY_OUTPUT_PATH})
@@ -222,16 +228,16 @@ add_subdirectory(VV)
 add_subdirectory(LFV)
 
 target_link_libraries(dlpolykim dlpolycore)
+target_link_libraries(dlpolyplumed dlpolycore)
 target_link_libraries(dlpolythermo dlpolycore)
-target_link_libraries(dlpoly dlpolycore dlpolykim)
+target_link_libraries(dlpoly dlpolycore dlpolykim dlpolyplumed)
 
 add_executable(${target_name} dl_poly.f90)
 set_target_properties(${target_name} PROPERTIES LINK_FLAGS "${OMP_LINK_FLAGS} ${MIC_LINK_FLAGS}")
 if(ADVISOR)
   target_include_directories(${target_name} PUBLIC ${ADVISOR_MODULE_DIRS})
 endif(ADVISOR)
-target_link_libraries(${target_name} ${LIBS} dlpoly dlpolycore dlpolythermo dlpolyvv dlpolylfv dlpolykim)
-
+target_link_libraries(${target_name} ${LIBS} dlpoly dlpolycore dlpolythermo dlpolyvv dlpolylfv dlpolykim dlpolyplumed)
 install(TARGETS ${target_name} RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})
 INSTALL_SUBLIB(dlpoly)
 INSTALL_SUBLIB(dlpolycore)
-- 
2.4.6

