\newcommand{\pad}[2]{\frac{\partial#1}{\partial#2}}
\newcommand{\pd}[2]{\frac{\partial#1}{\partial#2}}
\newcommand{\ssy}[1]{\scriptstyle{#1}}
%\newcommand{\apl}{{\lesssim}}
%\newcommand{\sssa}{{\stackrel{\ssy{i_1,i_2=1}}{\ssy{i_1\ne i_2}}}}
%\newcommand{\sssb}{{\stackrel{\ssy{i_1,...,i_k=1}}{\ssy{i_{\ell}\ne i_{\ell+1}}}}}
\newcommand{\nwc}{\newcommand}
\newcommand{\nn}{\nonumber}
\newcommand{\tbu}{\tilde{\mathbf{u}}}
\newcommand{\tbx}{\tilde{\mathbf{x}}}

\newcommand{\bF}{\mathbf{F}}
\newcommand{\bmj}{\mathbf{j}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bb}{\mathbf{b}}
%\newcommand{\be}{\mathbf{e}}
\newcommand{\cA}{{\mathcal A}}
%\newcommand{\sdiv}{\bm{\nabla}_s\cdot}
\newcommand{\hu}{\hat{u}}
\newcommand{\hv}{\hat{v}}
\newcommand{\hw}{\hat{w}}
\newcommand{\hf}{\hat{f}}
\newcommand{\hg}{\hat{g}}
\newcommand{\hh}{\hat{h}}

\newcommand{\vF}{\vec{F}}
\newcommand{\vu}{\vec{u}}
\newcommand{\vf}{\vec{f}}
\newcommand{\vb}{\vec{b}}
%\newcommand{\vr}{\vec{r}}

\newcommand{\RR}{\sf{R}}

%\newcommand{\diag}{\mbox{diag}}

\newcommand{\bivec}[2]{\left(\begin{array}{c}{#1} \\ {#2}\end{array}\right)}
\newcommand{\trivec}[3]{\left(\begin{array}{c}{#1} \\ {#2} \\ {#3}\end{array}\right)}
\newcommand{\xtext}[1]{\mbox{#1}}
\nwc{\bbb}{\overline}
\nwc{\m}{\mbox}
\nwc{\pa}{\partial}
\nwc{\ubm}{\unboldmath}
\nwc{\jt}[5]{{\em #1}, {\bf#2}#3, #4 (#5)}
\nwc{\newd}{\widetilde{\delta}}
\nwc{\bottom}{|\nabla_0^\ez\phi_{i,j}|}
\nwc{\pint}{-\!\!\!\!\!\!\int}
\nwc{\ezo}{\varepsilon _0}
\nwc{\ez}{\varepsilon}
\nwc{\rf}[1]{(\ref{#1})}
%\nwc{\ds}{\displaystyle}
\nwc{\IM}{\mbox{Im}}
\nwc{\RE}{\mbox{Re}}
\nwc{\volume}{{\cal V}}
\nwc{\phab}{\partial h_{\alpha\beta}}
\nwc{\hab}{h_{\alpha\beta}}
\nwc{\hba}{h_{\beta\alpha}}
\nwc{\hag}{h_{\beta\gamma}}
\nwc{\hbg}{h_{\beta\gamma}}
\nwc{\hdag}{h^{\dagger}}
\nwc{\hinv}{h^{-1}}
\nwc{\pphab}{\frac{\partial}{\partial h_{\alpha \beta}} }
\nwc{\sig}{\sigma}
\newcommand{\sab}{\sigma_{\alpha \beta}}

\newcommand{\bfr}{\begin{flushright}}
\newcommand{\efr}{\end{flushright}}
\newcommand{\bfl}{\begin{flushleft}}
\newcommand{\efl}{\end{flushleft}}
\newcommand{\bc}{\begin{center}}
\newcommand{\ec}{\end{center}}
\newcommand{\bfig}{\begin{figure}[h!]}
\newcommand{\efig}{\end{figure}}
\newcommand{\beq}{\begin{equation}}
\newcommand{\eeq}{\end{equation}}
\newcommand{\bea}{\begin{eqnarray}}
\newcommand{\eea}{\end{eqnarray}}
\newcommand{\bean}{\begin{eqnarray*}}
\newcommand{\eean}{\end{eqnarray*}}
\newcommand{\bse}{\begin{subequations}}
\newcommand{\ese}{\end{subequations}}
\newcommand{\bal}{\begin{align}}
\newcommand{\eal}{\end{align}}
\newcommand{\bit}{\begin{itemize}}
\newcommand{\eit}{\end{itemize}}
\newcommand{\benum}{\begin{enumerate}}
\newcommand{\eenum}{\end{enumerate}}
\newcommand{\bpartm}{\begin{displaymath}}
\newcommand{\edm}{\end{displaymath}}
%\renewcommand{\thefigure}{\thesection.\arabic{figure}}
\newcommand{\no}{\nonumber}
%\newcommand{\bf}[1]{\textbf{#1}}
%\newcommand{\it}[1]{\textit{#1}}
\newcommand{\pref}[1]{(\ref{#1})}
\newcommand{\vquad}{\vspace{0.5cm}}
\newcommand{\bssz}{\begin{scriptsize}}
\newcommand{\essz}{\end{scriptsize}}
\newcommand{\bfnsz}{\begin{footnotesize}}
\newcommand{\efnsz}{\end{footnotesize}}

% newcommands in math environments
\newcommand{\ita}{\textit{A}}
\newcommand{\itb}{\textit{B}}
\newcommand{\br}{\mathbf{r}}
\newcommand{\bri}{\mathbf{r_i}}
\newcommand{\brj}{\mathbf{r_j}}
\newcommand{\rij}{r_{ij}}
\newcommand{\rji}{r_{ji}}
\newcommand{\brij}{\mathbf{\rij}}
\newcommand{\brji}{\mathbf{\rji}}
\newcommand{\bx}{\mathbf{x}}
\newcommand{\by}{\mathbf{y}}
\newcommand{\bz}{\mathbf{z}}
\newcommand{\bxi}{\mathbf{x}_i}
\newcommand{\bxj}{\mathbf{x}_j}
\newcommand{\byi}{\mathbf{y}_i}
\newcommand{\byj}{\mathbf{y}_j}
\newcommand{\bxc}{\mathbf{x}_c}
\newcommand{\byc}{\mathbf{y}_c}
\newcommand{\bei}{\mathbf{e}_i}
\newcommand{\bk}{\mathbf{k}}
\newcommand{\bff}{\mathbf{f}}
\newcommand{\bd}{\mathbf{D}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\bs}{\mathbf{s}}
\newcommand{\ba}{\mathbf{a}}
\newcommand{\bl}{\mathbf{l}}
\newcommand{\bon}{\mathbf{1}}
\newcommand{\btw}{\mathbf{2}}
\newcommand{\bze}{\mathbf{0}}
\newcommand{\btr}{\mathbf{3}}
\newcommand{\bfo}{\mathbf{4}}
\newcommand{\psix}{\psi(\bx)}
\newcommand{\phix}{\phi(\bx)}
\newcommand{\bdk}{\mathbf{D}^{\bk}}
\newcommand{\bdkx}{\mathbf{D}_{\bx}^{\bk}}
\newcommand{\bdky}{\mathbf{D}_{\by}^{\bk}}
\newcommand{\abk}{||\mathbf{k}||}
\newcommand{\abs}{||\mathbf{s}||}
\newcommand{\abn}{||\mathbf{n}||}
\newcommand{\abl}{||\mathbf{l}||}
\newcommand{\be}{\mathbf{e}}
\newcommand{\abmx}{\frac{\alpha}{\beta|\bx|}}
\newcommand{\bmx}{\frac{\beta}{|\bx|}}
\newcommand{\lca}{\textit{leaf-cluster}}
\newcommand{\lla}{\textit{leaf-leaf}}
\newcommand{\mecl}{CH$_3$Cl}
\newcommand{\acal}{\mathcal{A}}
\newcommand{\bcal}{\mathcal{B}}
\newcommand{\angs}{\buildrel _{\circ} \over {\mathrm{A}}}
\newcommand{\gray}{[gray]{0.5}}
\newcommand{\Lihat}{\hat{L}_i}
\newcommand{\Ljhat}{\hat{L}_{j_i}}
\newcommand{\bpi}{{\mathbf{p}}_i}
\newcommand{\bpj}{{\mathbf{p}}_j}
\newcommand{\bqi}{{\mathbf{Q}}_i}
\newcommand{\bqj}{{\mathbf{Q}}_j}
\newcommand{\boi}{{\mathbf{O}}_i}
\newcommand{\boj}{{\mathbf{O}}_j}
\newcommand{\bhi}{{\mathbf{H}}_i}
\newcommand{\bhj}{{\mathbf{H}}_j}
\newcommand{\veoe}{V_o\epsilon_0\epsilon}
\newcommand{\fpieoe}{4\pi\epsilon_0\epsilon}
\newcommand{\epieoe}{8\pi\epsilon_0\epsilon}
\newcommand{\texp}{\textrm{exp}}
\newcommand{\mcal}{\mathcal{M}}
\newcommand{\fcal}{\mathcal{F}}
\newcommand{\jcal}{\mathcal{J}}
\newcommand{\dcal}{\mathcal{D}}
\newcommand{\eikr}{{\textrm{e}}^{\imath \bk \cdot \bri}}
\newcommand{\meikr}{{\textrm{e}}^{-\imath \bk \cdot \bri}}
\newcommand{\pko}{\left(k_1\right)}
\newcommand{\pktw}{\left(k_2\right)}
\newcommand{\pkth}{\left(k_3\right)}
\newcommand{\pkj}{\left(k_j\right)}
\newcommand{\xb}{\bar{x}}
\newcommand{\xbb}{\bar{\mathbf{x}}}
\newcommand{\phibx}{\phi(|\xbb|)}
\newcommand{\psibx}{\psi(|\bx|)}
\newcommand{\ttbx}{\theta(|\bx|)}
\newcommand{\erf}{\textrm{erf}}
\newcommand{\rcut}{r_{\textrm{cut}}}
\newcommand{\erfc}{\textrm{erfc}}
\newcommand{\bll}{{\bf \ell}}
\newcommand{\bpart}{{\bf \partial}}
\newcommand{\pct}{{\emph{particle-cluster}}}
\newcommand{\cpt}{{\emph{cluster-particle}}}
\newcommand{\cct}{{\emph{cluster-cluster}}}

\D offers advanced potential energy calculations through multipolar
electrostatics.  This is an extension to the point-charge model
where the charge density of chemical species are described by higher
order point multipoles. The generic algorithms in \D are designed to
allow for arbitrary order \cite{boateng-15a} multipoles but for
practical reasons the functionality is limited to hexadecapoles only.

\subsubsection*{Multipoles}

Define the multipolar operator, $\Lihat$ as
\beq
\Lihat = (q_i + \bpi \cdot \nabla_i + \bqi : \nabla_i\nabla_i +
\boi \scalebox{0.7}{\vdots} \nabla_i\nabla_i\nabla_i +
\bhi :: \nabla_i\nabla_i\nabla_i\nabla_i + \dots)~~,
\eeq
where $q_i$, $\bpi$, $\bqi$, $\boi$, and $\bhi$ are the point charge,
dipole, quadrupole, octupole,  and hexadecapole tensors, respectively of atom
\emph{i}, $\nabla_i$ refers to the three-dimensional gradient with respect
to the position of atom \emph{i} and the ``dot" products stand for tensor
contraction. By defining a unidimensional vector of independent (non-degenerate)
multipole moments, $\mcal_i$, for atom \emph{i}, the corresponding multipolar
operator to an arbitrary order $p$ can be written in a more compact form as
\beq
\Lihat = \sum_{\abs = 0}^{p}\mcal_{i}^{\bs}\bpart_{i}^{\bs} =
\sum_{s_3 = 0}^{p}\sum_{s_2 = 0}^{p-s_3}\sum_{s_1=0}^{p-s_3-s_2} \mcal_{j}^{s_1 s_2 s_3}
{\partial}_{z_i}^{s_3}{\partial}_{y_i}^{s_2}{\partial}_{x_i}^{s_1}~~.\label{defLi}
\eeq
Here, $\bs = (s_1,s_2,s_3)$ is the triplet that runs over all independent multipoles,
$\abs = s_1 + s_2 + s_3$, $\mcal_{i}^{\bs}=\mcal_{i}^{s_1 s_2 s_3}$ and
$\bpart_{i}^{\bs} = {\partial}_{z_i}^{s_3}{\partial}_{y_i}^{s_2}{\partial}_{x_i}^{s_1}$
is the multidimensional derivative with respect to the position
$\langle x_i, y_i, z_i \rangle $ of atom \emph{i} with orders
$s_1$, $s_2$ and $s_3$ in the $x$, $y$ and $z$ directions respectively.
Individual components of $\mcal$ contain the sum of all degenerate
original multipole components. As an example, the octupole $\mcal^{111}$,
is a sum of all six degenerate original octupole components formed
from the permutation of the triplet $\{x,y,z\}$~.  If the original octupole
vector with degnerate components is labelled as $O'$, then \\
\noindent $\mcal^{111}= O_{xyz}' + O_{xzy}' + O_{yxz}' + O_{yzx}' + O_{zxy}' + O_{zyx}' = 6~O_{xyz}'$~.
For pair potentials it is often convenient to redefine the multipolar
operator for atom \emph{j} in terms of the derivatives with respect
to the position of atom \emph{i} to arrive at
\beq
\Ljhat = \sum_{\abs = 0}^{p}\mcal_{j}^{\bs}\bpart_{j}^{\bs} =
\sum_{\abs = 0}^{p}(-1)^{||\bs||}\mcal_{j}^{\bs}\bpart_{i}^{\bs} =
\sum_{s_3 = 0}^{p}\sum_{s_2 = 0}^{p-s_3}\sum_{s_1=0}^{p-s_3-s_2}
(-1)^{s_1+s_2+s_3}\mcal_{j}^{s_1 s_2 s_3}
{\partial}_{z_i}^{s_3}{\partial}_{y_i}^{s_2}{\partial}_{x_i}^{s_1}~~.\label{defLj}
\eeq

\subsubsection*{Application to Pair Potentials}
\label{apptopairpot}
In \D for $N$ point-multipoles interacting via a pair potential function
$\psi$, the multipolar electrostatic potential at position $\bri$ is computed as
\beq
\phi(\bri) =  \sum_{j \ne i}^{N}\Ljhat \psi(\brji) = \sum_{j \ne i}^{N} \sum_{\bs = \bze}^{p}
(-1)^{||\bs||}\mcal_{j}^{\bs}\bpart_{i}^{\bs}\psi(\rij)~~,\label{eqn:mpolpot}
\eeq
the electrostatic field at $\bri$ is
\beq
\mathbf{E}(\brij) = -\nabla_i \phi(\rij)= -\sum_{j \ne i}^{N} \sum_{\bs = \bze}^{p}
(-1)^{||\bs||}\mcal_{j}^{\bs}\left[\begin{array}{l} \bpart_{i}^{\bs + \be_1} \\
\bpart_{i}^{\bs + \be_2} \\
\bpart_{i}^{\bs + \be_3}
\end{array}\right]\psi(\rij)~~,\label{eqn:mpolefield}
\eeq
where $\be_1=\langle1,0, 0\rangle$, $\be_2=\langle0,1,0\rangle$, and
$\be_3=\langle0,0,1\rangle$ and the torque \cite{sagui-04a} on particle
$i$ in the $\alpha$-direction, $\tau_{i,\alpha}$, is obtained as
\beq
\tau_{i,\alpha} = \sum_{\bs = \bze}^{p} \mcal_{i,\alpha}^{\bs} \bpart_{i}^{\bs} \phi(\brij)
= \sum_{\bs = \bze}^{p} \mcal_{i,\alpha}^{\bs} \sum_{j \ne i}^{N} \sum_{\bk = \bze}^{p}
(-1)^{||\bk||}\mcal_{j}^{\bk}\bpart_{i}^{\bs+\bk}\psi(\rij)~~,
\eeq
where $\mcal_{i,\alpha}$ is the infinitesimal counter-clockwise
rotation of multipole vector $\mcal_i$ about the $\alpha$-axis.
The total electrostatic potential energy is given by
\beq
U = \sum_{i < j}^{N} \Lihat\Ljhat \psi(\rij) = \sum_{i < j}^{N} \sum_{\bs = \bze}^{p}
(-1)^{||\bs||}\mcal_{j}^{\bs}\sum_{\bk = \bze}^{p}\mcal_{i}^{\bk}\bpart_{i}^{\bs+\bk}\psi(\rij)~~,\label{eqn:mpolene}
\eeq
where $\bs + \bk = (s_1+k_1,s_2+k_2,s_3+k_3)$ and the force on atom $i$ is
\beq
{\bf f}_i = -\nabla_i \sum_{j \ne i}^{N} \Lihat\Ljhat \psi(\rij) =
            -\sum_{j \ne i}^{N} \sum_{\bs = \bze}^{p}(-1)^{||\bs||}\mcal_{j}^{\bs}
             \sum_{\bk = \bze}^{p}\mcal_{i}^{\bk}
\left[\begin{array}{l}
\bpart_{i}^{\bs +\bk + \be_1} \\
\bpart_{i}^{\bs +\bk + \be_2} \\
\bpart_{i}^{\bs +\bk + \be_3}
\end{array}\right] \psi(\rij)~~.\label{eqn:mpolforce}
\eeq
To implement equations~(\ref{eqn:mpolpot})-(\ref{eqn:mpolforce}) for the
variety of potentials in \D a number of recurrence relations are used to
compute the multi-dimensional derivatives of the kernels corresponding
to the potentials.  These kernels are
\beq
\ttbx = \frac{1}{{|\bx|}^{\nu}},\mbox{\hskip 10pt}\Omega(|\bx|) = \frac{1}{2}\texp(-\alpha^2|\bx|^2), \mbox{\hskip 10pt }
 \psibx=\frac{\sqrt{\pi}}{2} \frac{\erfc(\alpha|\bx|)}{|\bx|},
\mbox{\hskip 10pt and \hskip 10pt }\Gamma(|\xbb|)= \frac{\sqrt{\pi}}{2} \frac{\erf(\alpha |\bx|)}{|\bx|}~~;
\eeq
with
\beq
a_{\bs}(\nu)=\frac{\partial^{||\bs||}\ttbx}{\partial_{x_1}^{s_1}\partial_{x_2}^{s_2}\partial_{x_3}^{s_3}},\mbox{\hskip 10pt}
b_{\bs}=\frac{\partial^{||\bs||}\Omega(|\bx|)}{\partial_{x_1}^{s_1}\partial_{x_2}^{s_2}\partial_{x_3}^{s_3}},\mbox{\hskip 10pt}
c_{\bs}=\frac{\partial^{||\bs||}\psibx}{\partial_{x_1}^{s_1}\partial_{x_2}^{s_2}\partial_{x_3}^{s_3}},\mbox{\hskip 10pt and \hskip 10pt}
d_{\bs}=\frac{\partial^{||\bs||}\Gamma(|\xbb|)}{\partial_{x_1}^{s_1}\partial_{x_2}^{s_2}\partial_{x_3}^{s_3}}~~.
\eeq
The recurrence relations used in \D are
\beq
a_{\bs}(\nu) = \frac{1}{|\bx|^2}\left\{\left(\frac{2-\nu}{||\bs||} - 2\right)
\sum_{i=1}^{3}s_i x_i a_{\bs-\be_i} + \left(\frac{2-\nu}{||\bs||} - 1\right)
\sum_{i=1}^{3}s_i (s_i-1) a_{\bs-2\be_i} \right\}~~,\label{coulrecur}
\eeq
\beq
b_{\bs} = \frac{-2\alpha^2}{||\bs||} \sum_{i=1}^{3}
\left[ s_i x_i b_{\bs-\be_i} + s_i (s_i-1) b_{\bs-2\be_i} \right]~~,\label{eqn:exprecur}
\eeq
\beq
c_{\bs} = \frac{1}{|\bx|^2} \left\{\left(\frac{1}{||\bs||} - 2\right)
\sum_{i=1}^{3}s_i x_i c_{\bs-\be_i} + \left(\frac{1}{||\bs||} - 1\right)
\sum_{i=1}^{3}s_i (s_i-1) c_{\bs-2\be_i} + \frac{1}{\alpha} b_{\bs} \right\}~~,\label{eqn:erfcrecur}
\eeq
and
\beq
d_{\bs} = \frac{1}{|\bx|^2}\left\{\left(\frac{1}{||\bs||} - 2\right)
\sum_{i=1}^{3}s_i x_i d_{\bs-\be_i} + \left(\frac{1}{||\bs||} - 1\right)
\sum_{i=1}^{3}s_i (s_i-1) d_{\bs-2\be_i} -\frac{1}{\alpha} b_{\bs} \right\}~~.\label{eqn:erfrecur}
\eeq

\subsubsection{Direct Coulomb Sum}
For two interacting ions $i$ and $j$, the potential energy is given as
\beq
U(\rij) = \frac{1}{\fpieoe}\Lihat\Ljhat\left[\frac{1}{\rij}\right]~~,
\eeq
and the relevant kernel is $\psi(\rij) = \frac{1}{\rij}$~.  The derivatives for
this kernel are obtained by  using equation~(\ref{coulrecur}) with $\nu = 1$~.  Thus,
\beq
\bpart_i^{\bs}\psi(\rij) = a_{\bs}(1)~~.
\eeq
In \D the multipolar direct Coulomb sum is handled by the routine {\sc coul\_cp\_mforces}.

\subsubsection{Force-Shifted Coulomb Sum}
\D employs two forms of the force-shifted Coulomb sum.  In the first
form, the potential  energy due to two interacting ions $i$ and $j$ is
\beq
U(\rij) = \frac{1}{\fpieoe} \Lihat \Ljhat \left[\frac{1}{\rij}+\frac{\rij}{\rcut^2}-\frac{2}{\rcut}\right]~~,
\eeq
where $\rcut$ is the cutoff radius.  The kernel is
$\psi(\rij) = \frac{1}{\rij}+\frac{\rij}{\rcut^2}-\frac{2}{\rcut}$~.
The last term, $\frac{2}{\rcut}$, is a constant which has a zero
derivative, hence the  derivatives of the kernel are obtained as
a sum of the derivatives of the first term and second terms.  Thus,
\beq
\bpart_i^{\bs}\psi(\rij) = a_{\bs}(1)+\frac{a_{\bs}(-1)}{\rcut^2}~~.
\eeq

The potential energy due to two point-multipoles $i$ and $j$ interacting
via the second form of the force-shifted Coulomb sum is
\bea
U(\rij) &=& \frac{1}{\fpieoe}\Lihat\Ljhat\left[ \left\{ \frac{\erfc(\alpha \cdot \rij)}{\rij} +
            \left( \frac{\erfc(\alpha \cdot \rcut)}{\rcut^2} + \frac{2\alpha}{\sqrt{\pi}}
            \frac{\texp(-\alpha^2\rcut^2)}{\rcut}\right)\rij \right\} - \phantom{xxxxxxxxx} \right. \nonumber \\
        & & \left. \phantom{xxxxxxxxx} \left\{ \frac{\erfc(\alpha \cdot \rcut)}{\rcut} +
            \left( \frac{\erfc(\alpha \cdot \rcut)}{\rcut^2} +
            \frac{2\alpha}{\sqrt{\pi}}\frac{\texp(-\alpha^2\rcut^2)}{\rcut}\right)\rcut \right\} \right]~~.
\eea
The kernel, $\psi(\rij)$ is the terms in the square bracket but the
only terms which contribute to the derivatives are the first and second
terms which are functions of $\rij$~.  The derivative of the first term
is obtained from equations~(\ref{eqn:erfcrecur}) and the derivative
for $\rij$ in the second term is given by $d_{\bs}(-1)$~.  Thus,
\beq
D_i^{\bs}\psi(\rij) = \frac{2}{\sqrt{\pi}}c_{\bs} + \left(\frac{\erfc(\alpha \cdot \rcut)}{\rcut^2} +
\frac{2\alpha}{\sqrt{\pi}} \frac{\texp(-\alpha^2\rcut^2)}{\rcut} \right) \cdot a_{\bs}(-1)~~.
\eeq
In \D the multipolar force-shifted Coulomb sum is handled by the routine {\sc coul\_fscp\_mforces}

\subsubsection{Coulomb Sum with Distance Dependent Dielectric}
The potential energy between two interacting ions $i$ and $j$ is
\beq
U(\rij) = \frac{1}{\fpieoe}\Lihat\Ljhat\left[\frac{1}{\rij^2}\right]~~,
\eeq
and the kernel is $\psi(\rij) = \frac{1}{\rij^2}$~.  The derivatives for this
kernel are obtained by using equation~(\ref{coulrecur}) with $\nu = 2$~.  Hence,
\beq
\bpart_i^{\bs}\psi(\rij) = a_{\bs}(2)~~.
\eeq
In \D the multipolar Coulomb sum with distance dependent dielectric is handled by the routine {\sc coul\_dddp\_mforces}.

\subsubsection{Reaction Field}
\D provides two forms of a multipolar reaction field potential.
In the first form, the effective pair potential energy due to
two interacting point multipoles $i$ and $j$ is given as
\beq
U(\rij) = \frac{1}{\fpieoe}\Lihat\Ljhat \left[ \frac{1}{\rij} +
\frac{B_0\rij^2}{2R_c^3} - 1 - \frac{B_0}{2}\right]~~,
\eeq
where
\beq
B_0 = \frac{2(\epsilon_1 - 1)}{(2\epsilon_1 + 1)}~~,
\eeq
$R_c$ is the radius of the spherical cavity and $\epsilon_1$
is the dielectric constant outside the cavity.  Again the kernel $\psi(\rij)$
is the terms in the square bracket and only the first and second
terms contribute to its derivatives.  The derivatives of the first
and second terms are given by equation~(\ref{coulrecur}) with
$\nu = 1$ and $\nu = -2$ respectively.  Thus,
\beq
\bpart_i^{\bs}\psi(\rij) = a_{\bs}(1)+\frac{B_0}{2R_c^3} \cdot a_{\bs}(-2)~~.
\eeq
\noindent
The second form of the reaction field method is similar to that of
the force-shifted Coulomb sum.  The potential energy due to interacting ions $i$ and $j$ is
\bea
U(\rij) &=& \frac{1}{\fpieoe}\Lihat\Ljhat\left[ \left\{ \frac{\erfc(\alpha \cdot \rij)}{\rij} +
            \left( \frac{\erfc(\alpha \cdot \rcut)}{\rcut^2} + \frac{2\alpha}{\sqrt{\pi}}
            \frac{\texp(-\alpha^2\rcut^2)}{\rcut}\right)\rij \right\} - \phantom{xxxxxxxxx} \right. \\ \nonumber
        & & \left. \phantom{xxxxxxxxx} \left\{ \frac{\erfc(\alpha \cdot \rcut)}{\rcut} +
            \left( \frac{\erfc(\alpha \cdot \rcut)}{\rcut^2} +
            \frac{2\alpha}{\sqrt{\pi}}\frac{\texp(-\alpha^2\rcut^2)}{\rcut}\right)\rcut \right\} -
            \frac{B_0 \rcut^2}{2\rcut^3}+\frac{B_0\rij^2}{2\rcut^3} \right]~~.
\eea
The kernel, $\psi(\rij)$ is the terms in the square bracket and
the only terms which contribute  to the derivatives are the first,
second and last terms which are functions of $\rij$~.  The derivative
of the first term is obtained from equation~(\ref{eqn:erfcrecur})
and the derivative for $\rij$ in the second term is given by
$a_{\bs}(-1)$ and the derivative for $\rij^2$ in the last term
is given by $d_{\bs}(-2)$~.  Thus,
\beq
D_i^{\bs}\psi(\rij) = \frac{2}{\sqrt{\pi}}c_{\bs}+\left( \frac{\erfc(\alpha \cdot \rcut)}{\rcut^2} +
\frac{2\alpha}{\sqrt{\pi}}\frac{\texp(-\alpha^2\rcut^2)}{\rcut}\right) \cdot a_{\bs}(-1) +
\frac{B_0}{2\rcut^3} \cdot a_{\bs}(-2)~~.
\eeq
In \D the multipolar reaction field is handled by the routine {\sc coul\_rfp\_mforces}.

\subsubsection{Smoothed Particle Mesh Ewald}
\D provides two different smooth particle Mesh Ewald implementations
for multipolar electrostatics.  The first implementation is for
systems with charges, dipoles and quadrupoles and does not use
recurrence relations.  The second implementation, which uses
recurrence relations, is more general and allows for specification
of an arbitrary order up to hexadecapoles.

\noindent
When the multipolar form of SPME is employed, the total electrostatic
energy for a system on $N$ point ions is given as

\beq
U_c = U_{\textrm{dir}} + U_{\textrm{rec}} - U_{\textrm{excl}} - U_{\textrm{frzn}} - U_{\textrm{self}}~~,\label{eqn:totE}
\eeq
where
\beq
U_{\textrm{dir}} = \sum_{i < j}^{N^*} \sum_{\bn}^{'}\Lihat\Ljhat
\frac{\erfc(\alpha \cdot |\brij + \bn|)}{\fpieoe |\brij + \bn|}~~,\label{direwald}
\eeq
\beq
U_{\textrm{excl}} = \frac{1}{\fpieoe}\sum_{(i,j)\in M^*}
\Lihat\Ljhat \frac{\erf(\alpha \cdot \rij)}{\rij}~~,\label{exclewald}
\eeq
\beq
U_{\textrm{frzn}} = \frac{1}{\fpieoe}\sum_{(i,j)\in F^*}
\Lihat\Ljhat \frac{\erf(\alpha \cdot \rij)}{\rij}~~,\label{frznewald}
\eeq
\beq
U_{\textrm{self}} = \frac{1}{\epieoe}\lim_{| \bri |\to 0}\sum_{i = 1}^{N}
\Lihat\Lihat \frac{\textrm{erf}(\alpha \cdot |\bri |)}{|\bri|}~~,\label{selfewald}
\eeq
and
\beq
U_{\textrm{rec}} = \frac{1}{2\veoe}\displaystyle\sum_{\mathbf{k} \ne 0}
\frac{\textrm{exp}(-k^2/4\alpha^2)}{k^2}\left |S(\mathbf{k})\right|^2~~,\label{recewald}
\eeq
with
\beq
S(\bk) = \sum_{i=1}^N \Lihat \texp(\imath \bk \cdot \bri)~~.\label{eqn:sfac}
\eeq

\noindent
In the expressions above, $M^*$ is the set of all excluded
interactions due to intramolecular bonds in the simulation cell,
$F^*$ the set of frozen-frozen interactions in the simulation cell,
$N^* = N - M^* - F^*$, $V_o$ is the volume of the
simulation cell and $S(\bk)$ is the structure factor.

\subsubsection*{Real Space Sum}

The relevant kernel for the real space from equation~(\ref{direwald}) is
$\displaystyle \psi(\rij) = \frac{\erfc(\alpha |\brij + \bn|)}{|\brij + \bn|}$~.
\D uses the recurrence giving in equation~(\ref{eqn:erfcrecur}) to generate
the multidimensional derivatives of the kernel.  Thus, the derivatives of the
kernel are computed as
\beq
\bd_i^{\bs}\psi(\rij) = \frac{2}{\sqrt{\pi}}c_{\bs}~~.
\eeq
\noindent
In \D the routine {\sc ewald\_real\_mforces\_d} computes the real space
interactions explicitly for simulations with multipoles of order 2 without
using the recurrence relation.  The routine {\sc ewald\_real\_mforces}
handles the general version of up to order 4 using recurrence relations.

\subsubsection*{Excluded Sum}

The relevant kernel for the real space from equation~(\ref{exclewald}) is
$\displaystyle \psi(\rij) = \frac{\erf(\alpha \cdot \rij)}{\rij}$~.
\D uses the recurrence giving in equation~(\ref{eqn:erfrecur}) to generate
the multidimensional derivatives of the kernel.  Thus, the derivatives of
the kernel are computed as
\beq
\bd_i^{\bs}\psi(\rij) = \frac{2}{\sqrt{\pi}}d_{\bs}~~.
\eeq
\noindent
In \D the routine {\sc ewald\_excl\_mforces\_d} computes the reciprocal
space corrections due to the exclusions between intramolecularly related
atoms explicitly for simulations with multipoles of order 2 without
using the recurrence relation.  The routine {\sc ewald\_excl\_mforces}
handles the general version of up to order 4 using recurrence relations.

\subsubsection*{Frozen Sum}

The relevant kernel for the real space from equation~(\ref{frznewald}) is
$\displaystyle \psi(\rij) = \frac{\erf(\alpha \cdot \rij)}{\rij}$~.
\D uses the recurrence giving in equation~(\ref{eqn:erfrecur}) to generate
the multidimensional derivatives of the kernel.  Thus, the derivatives of
the kernel are computed as
\beq
\bd_i^{\bs}\psi(\rij) = \frac{2}{\sqrt{\pi}}d_{\bs}~~.
\eeq
\noindent
In \D the routine {\sc ewald\_frzn\_mforces} computes computes the
reciprocal space corrections due to the exclusions between frozen
atoms generically for simulations with multipoles up to order 4
using recurrence relations.

\subsubsection*{Self-Interaction}

\D computes $U_{self}$ directly for interactions involving multipoles up
to order 4 using the series representation of the kernel
$\displaystyle \psi(\rij) = \frac{\erf(\alpha \cdot r_i)}{r_i}$~.
The self interaction is computed in {\sc ewald\_real\_mforces\_d} for
simulations with multipoles of maximum order 2.  For simulations of
arbitrary order, the self-interaction is computed in the reciprocal space.

\subsubsection*{Reciprocal Space Sum}

\noindent
The key idea of SPME is in approximating the structure factor, in a uniform grid,
with  $K_1 \times K_2 \times K_3$ dimensions, that fills the simulation cell.
Define the fractional coordinates of an ion $i$ as \\
\noindent $\langle s_{i_{1}}, s_{i_{2}}, s_{i_{3}} \rangle = \langle \ba_1^*\cdot \bri, \ba_2^*\cdot \bri, \ba_3^*\cdot \bri \rangle$,
$u_{\alpha_i} = K_{\alpha} \cdot s_i^{\alpha}$ and $M_n$ is a B-spline of order
$n$ then the approximation of the structure factor is given as
\beq
S(\bk) \approx b_1(k_1)b_2(k_2)b_3(k_3) Q^{\fcal}(k_1,k_2,k_3)~~,\label{skapprox}
\eeq
where $\bk = \langle k_1, k_2, k_3 \rangle$ is a reciprocal space vector,
\beq
b_i(k_i) = \texp(2\pi \imath (n-1)k_i/K_i)\left[\sum_{l=0}^{n-2}M_n(l+1)\texp(2\pi \imath k l/K_i)\right ]^{-1},
\eeq
$Q$ is the multipolar array defined on the uniform grid and $Q^{\fcal}$ its discrete
Fourier transform.  At position $(l_1,l_2,l_3)$ on the grid, the multipolar array is defined by
\beq
Q(l_1,l_2,l_3)=\sum_{i=1}^{N}\Lihat \sum_{n_1,n_2,n_3} M_n(u_{1_i}-l_1-n_1 K_1) \times
M_n(u_{2_i}-l_2-n_2 K_2) \times M_n(u_{3_i}-l_3-n_3 K_3)~~,\label{marray1}
\eeq
where, $u_{\alpha_i}-l_{\alpha}-n_{\alpha}K_{\alpha}$ are evaluation points of
the B-spline on the grid that spans the fundamental cell and the periodic images.
Then from equation~(\ref{defLi}) and considering only the fundamental cell,
the multipolar array can be written explicitly as
\beq
Q(l_1,l_2,l_3) = \sum_{i=1}^{N}\sum_{s_3 = 0}^{p}\sum_{s_2 = 0}^{p-s_3}
\sum_{s_1=0}^{p-s_3-s_2}\mcal_{i}^{s_1 s_2 s_3} {\partial}_{z_i}^{s_3}
{\partial}_{y_i}^{s_2}{\partial}_{x_i}^{s_1}
\left\{ M_n(u_{1_i}-l_1) M_n(u_{2_i}-l_2) M_n(u_{3_i}-l_3)\right\}~~.\label{marray2}
\eeq

\noindent
To compute the arbitrary order multidimensional derivatives of the product of
three b-splines in  equation~(\ref{marray2}), \D uses the closed form formula:
\bea
 & & {\partial}_{z_i}^{s_3}{\partial}_{y_i}^{s_2}{\partial}_{x_i}^{s_1}
     \left\{ M_n(u_{1_i}-l_1) M_n(u_{2_i}-l_2) M_n(u_{3_i}-l_3)\right\} = \nonumber \\
 & & \displaystyle \sum_{k_3 = 0}^{s_3}\left(K_1 a_{13}^{*}\right)^{k_3}
     \binom{s_3}{k_3} \sum_{k_2=0}^{s_2}\left(K_1 a_{12}^{*}\right)^{k_2}
     \binom{s_2}{k_2}\sum_{k_1=0}^{s_1}\left(K_1 a_{11}^{*}\right)^{k_1}
     \binom{s_1}{k_1} {\partial}_{u_{1_i}}^{||\bk||}M_n(u_{1_i}-l_1) \times \\
 & & \displaystyle \sum_{j_3=0}^{s_3-k_3}\left(K_2 a_{23}^{*}\right)^{j_3}
     \left(K_3 a_{33}^{*}\right)^{s_3-k_3-j_3}\binom{s_3-k_3}{j_3}
     \sum_{j_2=0}^{s_2-k_2}\left(K_2 a_{22}^{*}\right)^{j_2}
     \left(K_3 a_{32}^{*}\right)^{s_2-k_2-j_2} \binom{s_2-k_2}{j_2} \times \nonumber \\
 & & \displaystyle \sum_{j_1=0}^{s_1-k_1}\left(K_2 a_{21}^{*}\right)^{j_1}
     \left(K_3 a_{31}^{*}\right)^{s_1-k_1-j_1} \binom{s_1-k_1}{j_1}
     {\partial}_{u_{2_i}}^{||{\bf j}||}M_n(u_{2_i}-l_2){\partial}_{u_{3_i}}^{||\bs-\bk-{\bf j}||}M_n(u_{3_i}-l_3)~~,\nonumber \label{dprodmn}
\eea
where ${\bf a}_{1}^{*} = \langle a_{11}^{*},a_{12}^{*},a_{13}^{*}\rangle$,
${\bf a}_{2}^{*} = \langle a_{21}^{*},a_{22}^{*},a_{23}^{*}\rangle$,
and ${\bf a}_{3}^{*} = \langle a_{31}^{*},a_{32}^{*},a_{33}^{*}\rangle$
are the reciprocal space basis vectors and $K_1$, $K_2$, and $K_3$,
the maximum number of grid points in the fundamental cell in the
$x$, $y$, and $z$ directions respectively.  For an orthogonal box, where
\beq
a_{12}^{*}=a_{13}^{*}=a_{21}^{*}=a_{23}^{*}=a_{31}^{*}=a_{32}^{*}=0~~,
\eeq
\D uses the simplification of equation~(\ref{dprodmn}) to
\bea
\label{dprodmnsimple}
 & & {\partial}_{z_i}^{s_3}{\partial}_{y_i}^{s_2}{\partial}_{x_i}^{s_1}
     \left\{ M_n(u_{1_i}-l_1) M_n(u_{2_i}-l_2) M_n(u_{3_i}-l_3)\right\}= \\
 & & \left(K_1 a_{11}^{*}\right)^{s_1}\left(K_2 a_{22}^{*}\right)^{s_2}
     \left(K_3 a_{33}^{*}\right)^{s_3}{\partial}_{u_{1_i}}^{s_1}M_n(u_{1_i}-l_1)
     {\partial}_{u_{2_i}}^{s_2}M_n(u_{2_i}-l_2){\partial}_{u_{3_i}}^{s_3}M_n(u_{3_i}-l_3)~~. \nonumber
\eea

\noindent
The formulas in equations~(\ref{dprodmn}) and (\ref{dprodmnsimple}) require
derivatives of a b-spline.  To compute an arbitrary $p_\textrm{th}$ order
derivative of a b-spline of order $n$, $M_n$, at an arbitrary grid point
$j$, \D uses the closed form formula
\beq
\frac{d^p}{d u^{p}}M_n(u_j) = \sum_{t=\textrm{max}\{0,j-k\}}^{\textrm{min}\{j-1,p\}}
\binom{p}{t}(-1)^{t}M_{k}(u_j-t)~~.\label{dmnj2}
\eeq

\noindent
In \D the stress tensor due to the reciprocal space, for an arbitrary $p_\textrm{th}$
order multipolar electrostatic interaction is computed by the formula
\beq
V\sab^{\textrm{rec}} = \frac{1}{2\veoe} \displaystyle \sum_{\bk \ne 0}
                       \frac{\textrm{exp}(-k^2/4\eta^2)}{k^2} \left\{ \left
                       |S(\bk)\right|^2 \left[\delta_{\alpha \beta}-2 \left(
                       \frac{k^2/4\eta^2 + 1}{k^2}\right) k_{\alpha} k_{\beta}\right] +
                       2S(\bk) S_i^{\beta}(-\bk) \frac{k_{\alpha}}{k_{\beta}} \right\}~~,\label{eqn:virialtensorcomponents}
\eeq
where
\beq
\jcal_i^{\bll}(\bk) = \mcal_i^{\bll}{\partial}_i^{\bll}\eikr~~,
\eeq
\beq
S_i^{\beta}(-\bk) = \sum_{\bll = \bze}^{p} \ell_{\beta} \sum_{i=1}^{N} \jcal_i^{\bll}(-\bk)~~,
\eeq
and $\bll = (\ell_1,\ell_2,\ell_3)$~.

In \D the routine {\sc ewald\_spme\_mforces\_d} computes the reciprocal space
interactions explicitly for simulations with multipoles of maximum order 2.
The routine {\sc ewald\_spme\_mforces} handles the general version with
multipoles up to order 4.

The \D subroutines required to calculate the contributions from the reciprocal space,
in addition to the routines used for the point charges, are:
\begin{enumerate}
\item {\sc bspgen\_mpoles}, in {\sc spme\_container} evaluates
equation~(\ref{dprodmn}) or (\ref{dprodmnsimple}) to compute the B-splines.
\item {\sc limit\_erfr\_deriv} in {\sc mpoles\_container} which computes
the limit of the derivatives of the kernel for the self-interaction term.
{\sc limit\_erfr\_deriv} is called in {\sc ewald\_spme\_mforces}.
\end{enumerate}
